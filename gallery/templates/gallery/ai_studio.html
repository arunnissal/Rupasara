{% extends "gallery/base.html" %}

{% block content %}

<h1 class="page-title">âœ¨ AI Studio</h1>

<p class="search-info">
    Generate a custom image from a text prompt using <strong>Stability AI</strong> or <strong>FLUX</strong>.
</p>

<!-- Provider toggle -->
<form method="post" class="ai-form" id="ai-form">
    {% csrf_token %}

    <div class="chip-row" style="margin-bottom:10px;">
        <!-- Stability disabled (credits required) -->
        <button type="button" class="chip-small ai-provider-chip disabled-chip" disabled
            style="opacity:0.4; cursor:not-allowed;">
            âœ¨ Stability (Inactive)
        </button>

        <button type="button" class="chip-small ai-provider-chip {% if provider == 'flux' %}chip-active{% endif %}"
            data-provider="flux">
            âš¡ FLUX
        </button>
    </div>

    <input type="hidden" name="provider" id="ai-provider-input" value="{{ provider|default:'stability' }}">
    <input type="hidden" name="style" id="ai-style-input" value="{{ style }}">

    <!-- Style chips -->
    <div class="section-compact">
        <p class="section-title">Style presets (optional)</p>
        <div class="chip-row">
            <button type="button" class="chip-small ai-style-chip" data-style="in anime illustration style">
                ðŸŽŽ Anime
            </button>
            <button type="button" class="chip-small ai-style-chip" data-style="highly detailed photorealistic, 4k">
                ðŸ“¸ Realistic
            </button>
            <button type="button" class="chip-small ai-style-chip" data-style="in soft watercolor painting style">
                ðŸŽ¨ Watercolor
            </button>
            <button type="button" class="chip-small ai-style-chip"
                data-style="isometric 3d render, trending on artstation">
                ðŸ§± Isometric 3D
            </button>
        </div>
    </div>

    <textarea name="prompt" rows="3" class="ai-textarea"
        placeholder="Example: sunset over an ancient temple in anime style">{{ prompt }}</textarea>

    <div class="ai-actions">
        <button type="submit" class="btn btn-primary" id="ai-generate-btn">
            <span class="btn-label">Generate Image</span>
            <span class="btn-spinner" aria-hidden="true"></span>
        </button>
        <span class="hint-text" id="ai-status-text">
            First generation may take a few seconds depending on API speed.
        </span>
    </div>
</form>

{% if error_message %}
<div class="alert alert-error" style="margin-top:18px;">
    {{ error_message }}
</div>
{% endif %}

{% if generated_image_data %}
<div class="section" style="margin-top:24px;">
    <p class="section-title">
        Result
        {% if provider == "flux" %}
        Â· FLUX
        {% else %}
        Â· Stability
        {% endif %}
    </p>
    <div class="ai-result">
        <img src="{{ generated_image_data }}" alt="Generated image" class="ai-image">
        <div class="ai-result-actions">
            <a href="{{ generated_image_data }}" download="rupasara-ai.png" class="btn btn-primary btn-small">
                Download
            </a>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("ai-form");
        const btn = document.getElementById("ai-generate-btn");
        const statusText = document.getElementById("ai-status-text");
        const providerInput = document.getElementById("ai-provider-input");
        const styleInput = document.getElementById("ai-style-input");
        const promptField = document.querySelector("textarea[name='prompt']");

        // Loading state on submit
        if (form && btn && statusText) {
            form.addEventListener("submit", function () {
                form.classList.add("ai-form-busy");
                btn.disabled = true;
                statusText.textContent = "Generating imageâ€¦ Please wait.";
            });
        }

        // Provider chips
        const providerChips = document.querySelectorAll(".ai-provider-chip");
        providerChips.forEach(chip => {
            chip.addEventListener("click", function () {
                const provider = this.dataset.provider || "stability";
                providerInput.value = provider;

                providerChips.forEach(c => c.classList.remove("chip-active"));
                this.classList.add("chip-active");
            });
        });

        // Style chips - append nicely to prompt and remember selected style
        const styleChips = document.querySelectorAll(".ai-style-chip");
        styleChips.forEach(chip => {
            chip.addEventListener("click", function () {
                const styleText = this.dataset.style || "";
                styleInput.value = styleText;

                // Visual active state
                styleChips.forEach(c => c.classList.remove("chip-active"));
                this.classList.add("chip-active");

                if (!promptField) return;
                let basePrompt = promptField.value.trim();

                // If style already roughly included, don't duplicate
                if (styleText && !basePrompt.toLowerCase().includes(styleText.toLowerCase())) {
                    if (basePrompt && !basePrompt.endsWith(",")) {
                        basePrompt += ", ";
                    }
                    basePrompt += styleText;
                    promptField.value = basePrompt;
                }
            });
        });
    });
</script>
{% endblock %}